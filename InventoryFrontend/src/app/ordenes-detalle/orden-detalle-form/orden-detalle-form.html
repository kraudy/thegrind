<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-4xl font-bold text-gray-900">
      {{ isEdit ? 'Editar Detalle de Orden' : 'Agregar Detalle a Orden #' + formOrdenDetalle.idOrden }}
    </h1>
    <button (click)="goBack()"
            class="inline-flex items-center px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg shadow-md transition">
      Volver
    </button>
  </div>

  <div class="bg-white shadow-xl rounded-xl overflow-hidden">
    <div class="p-8">
      <form (ngSubmit)="onSubmit()" #detalleForm="ngForm" class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- ID Orden (solo lectura) -->
          <div>
            <label for="idOrden" class="block text-sm font-medium text-gray-700 mb-2">
              ID Orden
            </label>
            <input id="idOrden"
                   type="number"
                   [(ngModel)]="formOrdenDetalle.idOrden"
                   name="idOrden"
                   readonly
                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
          </div>

          <!-- Número de línea (solo visible en edición) -->
          <div *ngIf="isEdit">
            <label for="idOrdenDetalle" class="block text-sm font-medium text-gray-700 mb-2">
              Número de Línea
            </label>
            <input id="idOrdenDetalle"
                   type="number"
                   [(ngModel)]="formOrdenDetalle.idOrdenDetalle"
                   name="idOrdenDetalle"
                   readonly
                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
          </div>

          <!-- PRODUCTO (ahora con búsqueda backend como en ProductoPrecioForm) -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Producto <span class="text-red-600">*</span>
            </label>

            <!-- Modo creación: búsqueda con autocomplete -->
            <div *ngIf="!isEdit; else editModeProducto">
              <input type="text"
                     [(ngModel)]="searchProducto"
                     (ngModelChange)="onSearchChange($event)"
                     name="searchProducto"
                     placeholder="Escribe nombre o ID del producto..."
                     class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">

              <!-- Lista de sugerencias -->
              <div *ngIf="productosFiltrados.length > 0" 
                   class="mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto">
                <div *ngFor="let p of productosFiltrados" 
                     (click)="seleccionarProducto(p)"
                     class="px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 last:border-0 flex justify-between items-center">
                  <div>
                    <span class="font-semibold text-gray-900">{{ p.id }}</span>
                    <span class="ml-3 text-gray-700">{{ p.nombre }}</span>
                  </div>
                  <span class="text-xs text-gray-500">{{ p.tipoProducto }}</span>
                </div>
              </div>

              <!-- Campo oculto para el ID -->
              <input type="hidden" [(ngModel)]="formOrdenDetalle.idProducto" name="idProducto" required>
            </div>

            <!-- Modo edición: producto fijo (readonly) -->
            <ng-template #editModeProducto>
              <input type="text"
                     [value]="searchProducto || 'Cargando producto...'"
                     disabled
                     class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50 cursor-not-allowed">
            </ng-template>
          </div>

          <!-- Cantidad -->
          <div>
            <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-2">
              Cantidad <span class="text-red-600">*</span>
            </label>
            <input id="cantidad"
                   type="number"
                   [(ngModel)]="formOrdenDetalle.cantidad"
                   name="cantidad"
                   required
                   min="1"
                   step="1"
                   (ngModelChange)="updateSubtotal()"
                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>

          <!-- Precio Unitario -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Precio Unitario <span class="text-red-600">*</span>
            </label>
            <select [(ngModel)]="formOrdenDetalle.precioUnitario"
                    name="precioUnitario"
                    required
                    (ngModelChange)="updateSubtotal()"
                    class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
              
              <option [ngValue]="null">Selecciona precio...</option>
              
              <option *ngFor="let precio of preciosDisponibles" 
                      [ngValue]="precio.precio">
                {{ precio.precio | number:'1.2-2' }} — {{ precio.descripcion }}
                <span *ngIf="precio.cantidadRequerida > 0" class="text-xs text-amber-600">
                  (mín. {{ precio.cantidadRequerida }})
                </span>
              </option>
            </select>
          </div>

          <!-- Subtotal -->
          <div>
            <label for="subtotal" class="block text-sm font-medium text-gray-700 mb-2">
              Subtotal
            </label>
            <input id="subtotal"
                   type="number"
                   step="0.01"
                   [(ngModel)]="formOrdenDetalle.subtotal"
                   name="subtotal"
                   readonly
                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
          </div>
        </div>

        <!-- Botones -->
        <div class="flex justify-end space-x-4 pt-6">
          <button type="button"
                  (click)="goBack()"
                  class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg shadow-md transition">
            Cancelar
          </button>
          <button type="submit"
                  [disabled]="detalleForm.invalid"
                  class="inline-flex items-center px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            {{ isEdit ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>